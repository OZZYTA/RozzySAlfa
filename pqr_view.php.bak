<?php
// This script and data application were generated by AppGini 5.94
// Download AppGini for free from https://bigprof.com/appgini/download/

	$currDir = dirname(__FILE__);
	include_once("{$currDir}/lib.php");
	@include_once("{$currDir}/hooks/pqr.php");
	include_once("{$currDir}/pqr_dml.php");

	// mm: can the current member access this page?
	$perm = getTablePermissions('pqr');
	if(!$perm['access']) {
		echo error_message($Translation['tableAccessDenied'], false);
		echo '<script>setTimeout(function() { window.location = "index.php?signOut=1"; }, 2000);</script>';
		exit;
	}

	$x = new DataList;
	$x->TableName = 'pqr';

	// Fields that can be displayed in the table view
	$x->QueryFieldsTV = [
		"`pqr`.`id`" => "id",
		"if(`pqr`.`fecha`,date_format(`pqr`.`fecha`,'%m/%d/%Y'),'')" => "fecha",
		"`pqr`.`tipoid`" => "tipoid",
		"concat('<i class=\"glyphicon glyphicon-', if(`pqr`.`sac`, 'check', 'unchecked'), '\"></i>')" => "sac",
		"`pqr`.`doc`" => "doc",
		"`pqr`.`nombres`" => "nombres",
		"`pqr`.`apellidos`" => "apellidos",
		"`pqr`.`telefono`" => "telefono",
		"`pqr`.`direccion`" => "direccion",
		"`pqr`.`tipopqr`" => "tipopqr",
		"`pqr`.`motivo`" => "motivo",
		"if(`pqr`.`fechainc`,date_format(`pqr`.`fechainc`,'%m/%d/%Y'),'')" => "fechainc",
		"`pqr`.`eps`" => "eps",
		"`pqr`.`regimen`" => "regimen",
		"`pqr`.`servicio`" => "servicio",
		"`pqr`.`descripcion`" => "descripcion",
		"`pqr`.`estado`" => "estado",
		"`pqr`.`condicion`" => "condicion",
		"if(`pqr`.`cierre`,date_format(`pqr`.`cierre`,'%m/%d/%Y'),'')" => "cierre",
		"`pqr`.`dias`" => "dias",
		"`pqr`.`diascierre`" => "diascierre",
		"`pqr`.`indicador`" => "indicador",
		"`pqr`.`detalle1`" => "detalle1",
		"`pqr`.`detalle2`" => "detalle2",
		"`pqr`.`detalle3`" => "detalle3",
		"`pqr`.`soportes`" => "soportes",
		"concat('<i class=\"glyphicon glyphicon-', if(`pqr`.`fallecido`, 'check', 'unchecked'), '\"></i>')" => "fallecido",
		"`pqr`.`status`" => "status",
		"`pqr`.`asignado`" => "asignado",
		"`pqr`.`editado`" => "editado",
		"`pqr`.`periodo`" => "periodo",
		"`pqr`.`encargado`" => "encargado",
	];
	// mapping incoming sort by requests to actual query fields
	$x->SortFields = [
		1 => '`pqr`.`id`',
		2 => '`pqr`.`fecha`',
		3 => 3,
		4 => 4,
		5 => '`pqr`.`doc`',
		6 => '`pqr`.`nombres`',
		7 => 7,
		8 => 8,
		9 => '`pqr`.`direccion`',
		10 => 10,
		11 => 11,
		12 => '`pqr`.`fechainc`',
		13 => 13,
		14 => 14,
		15 => 15,
		16 => 16,
		17 => 17,
		18 => 18,
		19 => '`pqr`.`cierre`',
		20 => 20,
		21 => 21,
		22 => 22,
		23 => 23,
		24 => 24,
		25 => 25,
		26 => 26,
		27 => 27,
		28 => 28,
		29 => 29,
		30 => 30,
		31 => 31,
		32 => 32,
	];

	// Fields that can be displayed in the csv file
	$x->QueryFieldsCSV = [
		"`pqr`.`id`" => "id",
		"if(`pqr`.`fecha`,date_format(`pqr`.`fecha`,'%m/%d/%Y'),'')" => "fecha",
		"`pqr`.`tipoid`" => "tipoid",
		"`pqr`.`sac`" => "sac",
		"`pqr`.`doc`" => "doc",
		"`pqr`.`nombres`" => "nombres",
		"`pqr`.`apellidos`" => "apellidos",
		"`pqr`.`telefono`" => "telefono",
		"`pqr`.`direccion`" => "direccion",
		"`pqr`.`tipopqr`" => "tipopqr",
		"`pqr`.`motivo`" => "motivo",
		"if(`pqr`.`fechainc`,date_format(`pqr`.`fechainc`,'%m/%d/%Y'),'')" => "fechainc",
		"`pqr`.`eps`" => "eps",
		"`pqr`.`regimen`" => "regimen",
		"`pqr`.`servicio`" => "servicio",
		"`pqr`.`descripcion`" => "descripcion",
		"`pqr`.`estado`" => "estado",
		"`pqr`.`condicion`" => "condicion",
		"if(`pqr`.`cierre`,date_format(`pqr`.`cierre`,'%m/%d/%Y'),'')" => "cierre",
		"`pqr`.`dias`" => "dias",
		"`pqr`.`diascierre`" => "diascierre",
		"`pqr`.`indicador`" => "indicador",
		"`pqr`.`detalle1`" => "detalle1",
		"`pqr`.`detalle2`" => "detalle2",
		"`pqr`.`detalle3`" => "detalle3",
		"`pqr`.`soportes`" => "soportes",
		"`pqr`.`fallecido`" => "fallecido",
		"`pqr`.`status`" => "status",
		"`pqr`.`asignado`" => "asignado",
		"`pqr`.`editado`" => "editado",
		"`pqr`.`periodo`" => "periodo",
		"`pqr`.`encargado`" => "encargado",
	];
	// Fields that can be filtered
	$x->QueryFieldsFilters = [
		"`pqr`.`id`" => "ID",
		"`pqr`.`fecha`" => "Fecha",
		"`pqr`.`tipoid`" => "Tipo de Doc",
		"`pqr`.`sac`" => "Queja SAC?",
		"`pqr`.`doc`" => "Numero de Identificaci&#243;n:",
		"`pqr`.`nombres`" => "Nombres",
		"`pqr`.`apellidos`" => "Apellidos",
		"`pqr`.`telefono`" => "Telefono",
		"`pqr`.`direccion`" => "Direccion",
		"`pqr`.`tipopqr`" => "Tipo de PQR",
		"`pqr`.`motivo`" => "Motivo",
		"`pqr`.`fechainc`" => "Fecha del Incidente/Solicitud",
		"`pqr`.`eps`" => "Eps",
		"`pqr`.`regimen`" => "Regimen",
		"`pqr`.`servicio`" => "Servicio",
		"`pqr`.`descripcion`" => "Descripcion",
		"`pqr`.`estado`" => "Estado",
		"`pqr`.`condicion`" => "Condicion",
		"`pqr`.`cierre`" => "Fecha de Cierre",
		"`pqr`.`dias`" => "Dias en apertura",
		"`pqr`.`diascierre`" => "Dias para resoluci&#243;n",
		"`pqr`.`indicador`" => "Indicador",
		"`pqr`.`detalle1`" => "Detalle 1",
		"`pqr`.`detalle2`" => "Detalle 2",
		"`pqr`.`detalle3`" => "Detalle 3",
		"`pqr`.`soportes`" => "Soportes",
		"`pqr`.`fallecido`" => "Fallecido",
		"`pqr`.`status`" => "Status",
		"`pqr`.`asignado`" => "Asignado a",
		"`pqr`.`editado`" => "Editado por",
		"`pqr`.`periodo`" => "Periodo",
		"`pqr`.`encargado`" => "Encargado",
	];

	// Fields that can be quick searched
	$x->QueryFieldsQS = [
		"`pqr`.`id`" => "id",
		"if(`pqr`.`fecha`,date_format(`pqr`.`fecha`,'%m/%d/%Y'),'')" => "fecha",
		"`pqr`.`tipoid`" => "tipoid",
		"concat('<i class=\"glyphicon glyphicon-', if(`pqr`.`sac`, 'check', 'unchecked'), '\"></i>')" => "sac",
		"`pqr`.`doc`" => "doc",
		"`pqr`.`nombres`" => "nombres",
		"`pqr`.`apellidos`" => "apellidos",
		"`pqr`.`telefono`" => "telefono",
		"`pqr`.`direccion`" => "direccion",
		"`pqr`.`tipopqr`" => "tipopqr",
		"`pqr`.`motivo`" => "motivo",
		"if(`pqr`.`fechainc`,date_format(`pqr`.`fechainc`,'%m/%d/%Y'),'')" => "fechainc",
		"`pqr`.`eps`" => "eps",
		"`pqr`.`regimen`" => "regimen",
		"`pqr`.`servicio`" => "servicio",
		"`pqr`.`descripcion`" => "descripcion",
		"`pqr`.`estado`" => "estado",
		"`pqr`.`condicion`" => "condicion",
		"if(`pqr`.`cierre`,date_format(`pqr`.`cierre`,'%m/%d/%Y'),'')" => "cierre",
		"`pqr`.`dias`" => "dias",
		"`pqr`.`diascierre`" => "diascierre",
		"`pqr`.`indicador`" => "indicador",
		"`pqr`.`detalle1`" => "detalle1",
		"`pqr`.`detalle2`" => "detalle2",
		"`pqr`.`detalle3`" => "detalle3",
		"`pqr`.`soportes`" => "soportes",
		"concat('<i class=\"glyphicon glyphicon-', if(`pqr`.`fallecido`, 'check', 'unchecked'), '\"></i>')" => "fallecido",
		"`pqr`.`status`" => "status",
		"`pqr`.`asignado`" => "asignado",
		"`pqr`.`editado`" => "editado",
		"`pqr`.`periodo`" => "periodo",
		"`pqr`.`encargado`" => "encargado",
	];

	// Lookup fields that can be used as filterers
	$x->filterers = [];

	$x->QueryFrom = "`pqr` ";
	$x->QueryWhere = '';
	$x->QueryOrder = '';

	$x->AllowSelection = 1;
	$x->HideTableView = ($perm['view'] == 0 ? 1 : 0);
	$x->AllowDelete = $perm['delete'];
	$x->AllowMassDelete = true;
	$x->AllowInsert = $perm['insert'];
	$x->AllowUpdate = $perm['edit'];
	$x->SeparateDV = 1;
	$x->AllowDeleteOfParents = 0;
	$x->AllowFilters = (getLoggedAdmin() !== false);
	$x->AllowSavingFilters = (getLoggedAdmin() !== false);
	$x->AllowSorting = 1;
	$x->AllowNavigation = 1;
	$x->AllowPrinting = 1;
	$x->AllowPrintingDV = 1;
	$x->AllowCSV = 1;
	$x->RecordsPerPage = 15;
	$x->QuickSearch = 1;
	$x->QuickSearchText = $Translation['quick search'];
	$x->ScriptFileName = 'pqr_view.php';
	$x->RedirectAfterInsert = 'pqr_view.php?SelectedID=#ID#';
	$x->TableTitle = 'PQRs';
	$x->TableIcon = 'resources/table_icons/user_comment.png';
	$x->PrimaryKey = '`pqr`.`id`';
	$x->DefaultSortField = '18';
	$x->DefaultSortDirection = 'desc';

	$x->ColWidth = [150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, ];
	$x->ColCaption = ['Fecha', 'Tipo de Doc', 'Queja SAC?', 'Numero de Identificaci&#243;n:', 'Nombres', 'Apellidos', 'Telefono', 'Direccion', 'Tipo de PQR', 'Motivo', 'Eps', 'Regimen', 'Servicio', 'Estado', 'Condicion', 'Fecha de Cierre', 'Dias en apertura', 'Indicador', 'Soportes', 'Fallecido', 'Status', 'Asignado a', 'Periodo', 'Encargado', ];
	$x->ColFieldName = ['fecha', 'tipoid', 'sac', 'doc', 'nombres', 'apellidos', 'telefono', 'direccion', 'tipopqr', 'motivo', 'eps', 'regimen', 'servicio', 'estado', 'condicion', 'cierre', 'dias', 'indicador', 'soportes', 'fallecido', 'status', 'asignado', 'periodo', 'encargado', ];
	$x->ColNumber  = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 13, 14, 15, 17, 18, 19, 20, 22, 26, 27, 28, 29, 31, 32, ];

	// template paths below are based on the app main directory
	$x->Template = 'templates/pqr_templateTV.html';
	$x->SelectedTemplate = 'templates/pqr_templateTVS.html';
	$x->TemplateDV = 'templates/pqr_templateDV.html';
	$x->TemplateDVP = 'templates/pqr_templateDVP.html';

	$x->ShowTableHeader = 0;
	$x->TVClasses = "";
	$x->DVClasses = "";
	$x->HasCalculatedFields = true;
	$x->AllowConsoleLog = false;
	$x->AllowDVNavigation = true;

	// mm: build the query based on current member's permissions
	$DisplayRecords = $_REQUEST['DisplayRecords'];
	if(!in_array($DisplayRecords, ['user', 'group'])) { $DisplayRecords = 'all'; }
	if($perm['view'] == 1 || ($perm['view'] > 1 && $DisplayRecords == 'user' && !$_REQUEST['NoFilter_x'])) { // view owner only
		$x->QueryFrom .= ', `membership_userrecords`';
		$x->QueryWhere = "WHERE `pqr`.`id`=`membership_userrecords`.`pkValue` AND `membership_userrecords`.`tableName`='pqr' AND LCASE(`membership_userrecords`.`memberID`)='" . getLoggedMemberID() . "'";
	} elseif($perm['view'] == 2 || ($perm['view'] > 2 && $DisplayRecords == 'group' && !$_REQUEST['NoFilter_x'])) { // view group only
		$x->QueryFrom .= ', `membership_userrecords`';
		$x->QueryWhere = "WHERE `pqr`.`id`=`membership_userrecords`.`pkValue` AND `membership_userrecords`.`tableName`='pqr' AND `membership_userrecords`.`groupID`='" . getLoggedGroupID() . "'";
	} elseif($perm['view'] == 3) { // view all
		// no further action
	} elseif($perm['view'] == 0) { // view none
		$x->QueryFields = ['Not enough permissions' => 'NEP'];
		$x->QueryFrom = '`pqr`';
		$x->QueryWhere = '';
		$x->DefaultSortField = '';
	}
	// hook: pqr_init
	$render = true;
	if(function_exists('pqr_init')) {
		$args = [];
		$render = pqr_init($x, getMemberInfo(), $args);
	}

	if($render) $x->Render();

	// hook: pqr_header
	$headerCode = '';
	if(function_exists('pqr_header')) {
		$args = [];
		$headerCode = pqr_header($x->ContentType, getMemberInfo(), $args);
	}

	if(!$headerCode) {
		include_once("{$currDir}/header.php"); 
	} else {
		ob_start();
		include_once("{$currDir}/header.php");
		echo str_replace('<%%HEADER%%>', ob_get_clean(), $headerCode);
	}

	echo $x->HTML;

	// hook: pqr_footer
	$footerCode = '';
	if(function_exists('pqr_footer')) {
		$args = [];
		$footerCode = pqr_footer($x->ContentType, getMemberInfo(), $args);
	}

	if(!$footerCode) {
		include_once("{$currDir}/footer.php"); 
	} else {
		ob_start();
		include_once("{$currDir}/footer.php");
		echo str_replace('<%%FOOTER%%>', ob_get_clean(), $footerCode);
	}
